/*!
 * @license
 * EME Encryption Scheme Polyfill
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */

!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).EncryptionSchemePolyfills=e()}}((function(){var e={exports:{}};function i(e,i,t){return t?i?i(e):e:(e&&e.then||(e=Promise.resolve(e)),i?e.then(i):e)}function t(e,i,t){if(t)return i?i(e()):e();try{var n=Promise.resolve(e());return i?n.then(i):n}catch(o){return Promise.reject(o)}}function n(){}class o{static install(){o.originalRMKSA_||navigator.requestMediaKeySystemAccess&&MediaKeySystemAccess.prototype.getConfiguration&&(o.originalRMKSA_=navigator.requestMediaKeySystemAccess,navigator.requestMediaKeySystemAccess=o.probeRMKSA_)}static probeRMKSA_(e,n){const s=this;return t((function(){return i(o.originalRMKSA_.call(s,e,n),(function(i){return c(i)?(navigator.requestMediaKeySystemAccess=o.originalRMKSA_,i):(navigator.requestMediaKeySystemAccess=o.polyfillRMKSA_,o.polyfillRMKSA_.call(s,e,n))}))}))}static polyfillRMKSA_(e,n){const s=this;return t((function(){const t=r(e),c=[];for(const e of n){const i=o.filterCapabilities_(e.videoCapabilities,t),n=o.filterCapabilities_(e.audioCapabilities,t);if(e.videoCapabilities&&e.videoCapabilities.length&&!i.length);else if(e.audioCapabilities&&e.audioCapabilities.length&&!n.length);else{const t=Object.assign({},e);t.videoCapabilities=i,t.audioCapabilities=n,c.push(t)}}if(!c.length){const e=new Error("Unsupported keySystem or supportedConfigurations.");throw e.name="NotSupportedError",e.code=DOMException.NOT_SUPPORTED_ERR,e}return i(o.originalRMKSA_.call(s,e,c),(function(e){return new a(e,t)}))}))}static filterCapabilities_(e,i){return e?e.filter(e=>!e.encryptionScheme||e.encryptionScheme==i):e}}class s{static install(){s.originalDecodingInfo_||navigator.mediaCapabilities&&(s.originalDecodingInfo_=navigator.mediaCapabilities.decodingInfo,navigator.mediaCapabilities.decodingInfo=s.probeDecodingInfo_)}static probeDecodingInfo_(e){const n=this;return t((function(){return i(s.originalDecodingInfo_.call(n,e),(function(i){if(!e.keySystemConfiguration)return i;const t=i.keySystemAccess;return t&&c(t)?(navigator.mediaCapabilities.decodingInfo=s.originalDecodingInfo_,i):(navigator.mediaCapabilities.decodingInfo=s.polyfillDecodingInfo_,s.polyfillDecodingInfo_.call(n,e))}))}))}static polyfillDecodingInfo_(e){const o=this;return t((function(){let t=null;if(e.keySystemConfiguration){const n=e.keySystemConfiguration,o=n.keySystem,s=n.audio&&n.audio.encryptionScheme,a=n.video&&n.video.encryptionScheme;t=r(o);const c={powerEfficient:!1,smooth:!1,supported:!1,keySystemAccess:null,configuration:e};if(s&&s!=t)return i(c);if(a&&a!=t)return i(c)}return i(s.originalDecodingInfo_.call(o,e),(function(o){return r=function(){if(!o.keySystemAccess)return function(t){var a=function(){if(e.keySystemConfiguration){const t=s.convertToMediaKeySystemConfig_(e);return i(navigator.requestMediaKeySystemAccess(e.keySystemConfiguration.keySystem,[t]),(function(e){o.keySystemAccess=e}))}}();if(a&&a.then)return a.then(n)}();o.keySystemAccess=new a(o.keySystemAccess,t)},c=function(){return o},(l=r())&&l.then?l.then(c):c();var r,c,l}))}))}static convertToMediaKeySystemConfig_(e){const i=e.keySystemConfiguration,t=[],n=[];if(i.audio){const n={robustness:i.audio.robustness||"",contentType:e.audio.contentType};t.push(n)}if(i.video){const t={robustness:i.video.robustness||"",contentType:e.video.contentType};n.push(t)}const o={initDataTypes:i.initDataType?[i.initDataType]:[],distinctiveIdentifier:i.distinctiveIdentifier,persistentState:i.persistentState,sessionTypes:i.sessionTypes};return t.length&&(o.audioCapabilities=t),n.length&&(o.videoCapabilities=n),o}}class a{constructor(e,i){this.mksa_=e,this.scheme_=i,this.keySystem=e.keySystem}getConfiguration(){const e=this.mksa_.getConfiguration();if(e.videoCapabilities)for(const i of e.videoCapabilities)i.encryptionScheme=this.scheme_;if(e.audioCapabilities)for(const i of e.audioCapabilities)i.encryptionScheme=this.scheme_;return e}createMediaKeys(){return this.mksa_.createMediaKeys()}}function r(e){return e.startsWith("com.widevine")||e.startsWith("com.microsoft")||e.startsWith("com.adobe")||e.startsWith("org.w3")?"cenc":e.startsWith("com.apple")?"cbcs-1-9":(console.warn("EmeEncryptionSchemePolyfill: Unknown key system:",e,"Please contribute!"),null)}function c(e){const i=e.getConfiguration(),t=i.videoCapabilities&&i.videoCapabilities[0],n=i.audioCapabilities&&i.audioCapabilities[0],o=t||n;return!(!o||void 0===o.encryptionScheme)}o.originalRMKSA_,s.originalDecodingInfo_;return e.exports&&(e.exports=class{static install(){o.install(),s.install()}}),e=e.exports}));